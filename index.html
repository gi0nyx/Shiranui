<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiranui</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add Kuromoji for morphological analysis -->
   <script defer src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>

    <style>
        /* Additional styles for particle and conjugation highlighting */
        .particle-word {
            background: linear-gradient(135deg, #f59e0b20 0%, #f9731620 100%);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            border-bottom: 2px solid #f59e0b;
            cursor: help;
            transition: all 0.2s ease;
        }

        .particle-word:hover {
            background: linear-gradient(135deg, #f59e0b30 0%, #f9731630 100%);
            transform: translateY(-1px);
        }

        .conjugated-word {
            background: linear-gradient(135deg, #8b5cf620 0%, #7c3aed20 100%);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            border-bottom: 2px solid #8b5cf6;
            cursor: help;
            transition: all 0.2s ease;
        }

        .conjugated-word:hover {
            background: linear-gradient(135deg, #8b5cf630 0%, #7c3aed30 100%);
            transform: translateY(-1px);
        }

        /* Loading indicator */
        .loading-indicator {
            text-align: center;
            padding: 1rem;
            color: #666;
        }

        .dictionary-info {
            background: #0a0a0a;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #2a2a2a;
        }

        .dictionary-info h4 {
            color: #10b981;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-item {
            display: inline-block;
            margin: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #1a1a1a;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #999;
        }

        .form-item.matched {
            color: #10b981;
            border: 1px solid #10b981;
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="container">
        <div class="header">
            <h1>日本語 practice</h1>
            <p class="subtitle">kaishi 1.5k deck • type the romaji</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="practice">Practice</button>
            <button class="tab-btn" data-tab="reading">Reading</button>
        </div>

        <!-- Practice Tab -->
        <div class="tab-content active" id="practice-tab">
            <div class="range-selector">
                <label>practice words from</label>
                <input type="number" id="startRange" min="1" max="1500" value="1">
                <label>to</label>
                <input type="number" id="endRange" min="1" max="1500" value="10">
                <button id="updateRangeBtn">update range</button>
            </div>

            <div class="card" id="card">
                <div class="japanese-word" id="japaneseWord"></div>
                <div class="meaning" id="meaning"></div>
                <div class="input-wrapper">
                    <input type="text" id="romajiInput" placeholder="type romaji..." autocomplete="off">
                </div>
            </div>

            <div class="progress">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText"></div>
            </div>

            <div class="controls">
                <button id="resetBtn">restart</button>
                <button id="clearProgressBtn">clear saved progress</button>
            </div>
        </div>

        <!-- Reading Tab -->
        <div class="tab-content" id="reading-tab">
            <div class="reading-controls">
                <div class="range-display">
                    <span>Using words from <strong id="readingRangeStart">1</strong> to <strong id="readingRangeEnd">10</strong></span>
                </div>
                <div id="tokenizerStatus" class="loading-indicator" style="display: none;">
                    Loading Japanese analyzer...
                </div>
            </div>

            <div class="reading-section">
                <div class="input-section">
                    <label for="japaneseText">Enter Japanese text to analyze:</label>
                    <textarea 
                        id="japaneseText" 
                        placeholder="日本語のテキストを入力してください..."
                        rows="6"
                    ></textarea>
                    <button id="analyzeBtn">Analyze Text</button>
                </div>

                <div class="analysis-results" id="analysisResults" style="display: none;">
                    <div class="stats-card">
                        <div class="stat-item">
                            <span class="stat-label">Words Known</span>
                            <span class="stat-value" id="knownWordsCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Words</span>
                            <span class="stat-value" id="totalWordsCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Coverage</span>
                            <span class="stat-value" id="coveragePercent">0%</span>
                        </div>
                    </div>

                    <div class="highlighted-text-container">
                        <h3>Analyzed Text</h3>
                        <div id="highlightedText" class="highlighted-text"></div>
                    </div>

                    <div class="known-words-list" id="knownWordsList" style="display: none;">
                        <h3>Known Words Found</h3>
                        <div id="wordsListContent" class="words-grid"></div>
                    </div>

                    <div class="dictionary-info" id="dictionaryInfo" style="display: none;">
                        <h4>Recognized Word Forms</h4>
                        <div id="recognizedForms"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="stats">
        <div>streak: <span id="streak">0</span></div>
        <div>accuracy: <span id="accuracy">0%</span></div>
    </div>

    <script type="module">
        import kaishiWords from './kaishiWords.js';

        /* ---------- Storage Keys ---------- */
        const STORAGE_KEYS = {
            RANGE: 'shiranui_range',
            PROGRESS: 'shiranui_progress',
            STATS: 'shiranui_stats'
        };

        /* ---------- audio helper ---------- */
        const audio = new Audio();
        function playAudio(filename) {
            audio.src = `audio/${filename}.ogg`;
            audio.play().catch(e => console.log('audio play failed:', e));
        }

        /* ---------- state ---------- */
        let currentWords = [];
        let currentIndex = 0;
        let streak = 0, correct = 0, total = 0;
        let tokenizer = null;

        /* ---------- DOM ---------- */
        const japaneseWordEl = document.getElementById('japaneseWord');
        const meaningEl      = document.getElementById('meaning');
        const romajiInput    = document.getElementById('romajiInput');
        const progressFill   = document.getElementById('progressFill');
        const progressText   = document.getElementById('progressText');
        const streakEl       = document.getElementById('streak');
        const accuracyEl     = document.getElementById('accuracy');
        const startRangeEl   = document.getElementById('startRange');
        const endRangeEl     = document.getElementById('endRange');

        /* ---------- Initialize Kuromoji ---------- */
        function initializeKuromoji() {
            const statusEl = document.getElementById('tokenizerStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = 'Loading Japanese analyzer...';

            kuromoji.builder({ dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict" }).build((err, newTokenizer) => {
                if (err) {
                    console.error('Failed to load tokenizer:', err);
                    statusEl.textContent = 'Failed to load analyzer. Basic matching will be used.';
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                } else {
                    tokenizer = newTokenizer;
                    statusEl.textContent = 'Analyzer ready!';
                    setTimeout(() => statusEl.style.display = 'none', 1000);
                    console.log('Kuromoji tokenizer loaded successfully');
                }
            });
        }

        /* ---------- Local Storage Functions ---------- */
        function saveProgress() {
            const progressData = {
                currentIndex,
                streak,
                correct,
                total,
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(progressData));
        }

        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEYS.PROGRESS);
            if (saved) {
                const data = JSON.parse(saved);
                currentIndex = data.currentIndex || 0;
                streak = data.streak || 0;
                correct = data.correct || 0;
                total = data.total || 0;
                updateStats();
            }
        }

        function saveRange() {
            const rangeData = {
                start: startRangeEl.value,
                end: endRangeEl.value
            };
            localStorage.setItem(STORAGE_KEYS.RANGE, JSON.stringify(rangeData));
        }

        function loadRange() {
            const saved = localStorage.getItem(STORAGE_KEYS.RANGE);
            if (saved) {
                const data = JSON.parse(saved);
                startRangeEl.value = data.start;
                endRangeEl.value = data.end;
            }
        }

        function clearProgress() {
            localStorage.removeItem(STORAGE_KEYS.PROGRESS);
            localStorage.removeItem(STORAGE_KEYS.STATS);
            resetProgress();
        }

        /* ---------- core ---------- */
        function updateRange() {
            const start = +startRangeEl.value - 1;
            const end   = +endRangeEl.value;
            currentWords = kaishiWords.slice(start, end);
            saveRange();
            resetProgress();
            updateReadingRange();
        }

        function resetProgress() {
            currentIndex = streak = correct = total = 0;
            updateStats();
            loadWord();
            saveProgress();
        }

        function loadWord() {
            if (currentIndex >= currentWords.length) {
                currentIndex = 0;
                japaneseWordEl.innerHTML =
                    '<div class="complete-message">ご苦労様でした nice job!</div>';
                romajiInput.style.display = 'none';
                setTimeout(() => { romajiInput.style.display = 'block'; loadWord(); }, 2000);
                saveProgress();
                return;
            }
            const w = currentWords[currentIndex];
            japaneseWordEl.textContent = w.japanese;
            meaningEl.textContent = `${w.romaji} • ${w.meaning}`;
            romajiInput.value = '';
            romajiInput.classList.remove('correct','incorrect');
            romajiInput.focus();
            updateProgress();
        }

        function updateProgress() {
            const pct = (currentIndex / currentWords.length) * 100;
            progressFill.style.width = pct + '%';
            progressText.textContent = `${currentIndex} / ${currentWords.length}`;
        }

        function updateStats() {
            streakEl.textContent = streak;
            accuracyEl.textContent = total ? `${Math.round(correct/total*100)}%` : '0%';
        }

        function checkAnswer() {
            const user = romajiInput.value.trim().toLowerCase();
            const ans  = currentWords[currentIndex].romaji.toLowerCase();
            total++;

            if (user === ans) {
                romajiInput.classList.add('correct');
                correct++; streak++;
                playAudio(currentWords[currentIndex].romaji);
                console.log('playing audio:', currentWords[currentIndex].romaji);
                setTimeout(() => { 
                    currentIndex++; 
                    loadWord(); 
                    saveProgress();
                }, 500);
            } else {
                romajiInput.classList.add('incorrect');
                streak = 0;
                playAudio('zenzen');
                setTimeout(() => romajiInput.classList.remove('incorrect'), 500);
            }
            updateStats();
            saveProgress();
        }

        /* ---------- Tab Navigation ---------- */
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;
                
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`${targetTab}-tab`).classList.add('active');
                
                if (targetTab === 'reading') {
                    updateReadingRange();
                    if (!tokenizer) {
                        initializeKuromoji();
                    }
                }
            });
        });

        /* ---------- Enhanced Reading Analysis with Kuromoji ---------- */

        // NEW: helper to convert katakana to hiragana (for reading-based matches)
        function katakanaToHiragana(str) {
            return str.replace(/[\u30A1-\u30F6]/g, ch =>
                String.fromCharCode(ch.charCodeAt(0) - 0x60)
            );
        }

        function updateReadingRange() {
            document.getElementById('readingRangeStart').textContent = startRangeEl.value;
            document.getElementById('readingRangeEnd').textContent = endRangeEl.value;
        }

        function analyzeText() {
            const inputText = document.getElementById('japaneseText').value;
            if (!inputText.trim()) return;

            if (!tokenizer) {
                alert('Japanese analyzer is still loading. Please wait a moment and try again.');
                return;
            }

            // Tokenize with Kuromoji for morphological analysis
            const tokens = tokenizer.tokenize(inputText);
            console.log('Tokens:', tokens);

            // Create maps for known words
            const knownWordsMap = new Map();
            const knownBaseFormsMap = new Map(); // (kept as-is)
            const knownReadingsMap = new Map();  // NEW: reading (hiragana) -> [wordData]

            // Build maps, including readings derived via kuromoji
            currentWords.forEach(word => {
                knownWordsMap.set(word.japanese, word);
                knownBaseFormsMap.set(word.japanese, word);

                // Derive reading for the word using kuromoji (join sub-token readings)
                const wTokens = tokenizer.tokenize(word.japanese);
                let katakanaReading = wTokens.map(t => {
                    if (t.reading && t.reading !== '*') return t.reading;
                    // Fallback: if reading is missing, use surface form
                    return t.surface_form;
                }).join('');
                const hiraReading = katakanaToHiragana(katakanaReading);

                if (hiraReading) {
                    if (!knownReadingsMap.has(hiraReading)) {
                        knownReadingsMap.set(hiraReading, []);
                    }
                    knownReadingsMap.get(hiraReading).push(word);
                }
            });

            let highlightedHTML = '';
            let knownCount = 0;
            let conjugatedCount = 0;
            let totalWords = 0;
            const foundWords = new Map();
            const recognizedForms = new Map();

            tokens.forEach(token => {
                const surface = token.surface_form;
                const baseForm = token.basic_form;
                const pos = token.pos; // Part of speech
                const posDetail = token.pos_detail_1;
                const readingHira = (token.reading && token.reading !== '*')
                    ? katakanaToHiragana(token.reading)
                    : null;

                // Skip punctuation
                if (pos === '記号') {
                    highlightedHTML += surface;
                    return;
                }

                // Check for particles
                if (pos === '助詞' || pos === '助動詞') {
                    highlightedHTML += `<span class="particle-word" title="Particle: ${surface} (${posDetail})">${surface}</span>`;
                    totalWords++;
                    return;
                }

                // 1) Exact surface match
                if (knownWordsMap.has(surface)) {
                    const wordData = knownWordsMap.get(surface);
                    highlightedHTML += `<span class="known-word" title="${wordData.romaji} - ${wordData.meaning}">${surface}</span>`;
                    if (!foundWords.has(surface)) {
                        foundWords.set(surface, wordData);
                    }
                    knownCount++;
                    totalWords++;
                }
                // 2) Dictionary/base-form match (conjugations)
                else if (baseForm && baseForm !== surface && knownWordsMap.has(baseForm)) {
                    const wordData = knownWordsMap.get(baseForm);
                    highlightedHTML += `<span class="conjugated-word" title="Base: ${baseForm} (${wordData.romaji}) - ${wordData.meaning}">${surface}</span>`;
                    
                    // Track the conjugated form
                    if (!recognizedForms.has(baseForm)) {
                        recognizedForms.set(baseForm, {
                            base: wordData,
                            forms: new Set()
                        });
                    }
                    recognizedForms.get(baseForm).forms.add(surface);
                    
                    conjugatedCount++;
                    knownCount++; // Count as known since we know the base form
                    totalWords++;
                }
                // 3) NEW: Reading-based match (e.g., 私 ⇄ わたし)
                else if (readingHira && knownReadingsMap.has(readingHira)) {
                    const candidates = knownReadingsMap.get(readingHira);
                    // Pick the first candidate (homophones may exist)
                    const wordData = candidates[0];
                    const title = candidates.length === 1
                        ? `Reading match: ${wordData.japanese} (${wordData.romaji}) - ${wordData.meaning}`
                        : `Reading match (homophones): ${candidates.map(c => c.japanese).join(' / ')} • ${wordData.romaji} - ${wordData.meaning}`;
                    highlightedHTML += `<span class="known-word" title="${title}">${surface}</span>`;

                    const key = wordData.japanese;
                    if (!foundWords.has(key)) {
                        foundWords.set(key, wordData);
                    }
                    knownCount++;
                    totalWords++;
                }
                // 4) Unknown but with grammatical info
                else if (baseForm && baseForm !== '*') {
                    highlightedHTML += `<span class="unknown-word" title="Base: ${baseForm} (${pos})">${surface}</span>`;
                    totalWords++;
                }
                // 5) Completely unknown
                else {
                    highlightedHTML += `<span class="unknown-word">${surface}</span>`;
                    totalWords++;
                }
            });

            // Update display
            document.getElementById('highlightedText').innerHTML = highlightedHTML;
            document.getElementById('knownWordsCount').textContent = knownCount;
            document.getElementById('totalWordsCount').textContent = totalWords;
            document.getElementById('coveragePercent').textContent = totalWords > 0 
                ? `${Math.round((knownCount / totalWords) * 100)}%` 
                : '0%';

            // Display found words list
            const wordsList = document.getElementById('wordsListContent');
            wordsList.innerHTML = '';
            foundWords.forEach((wordData, word) => {
                const wordEl = document.createElement('div');
                wordEl.className = 'word-item';
                wordEl.innerHTML = `
                    <span class="word-japanese">${word}</span>
                    <span class="word-romaji">${wordData.romaji}</span>
                    <span class="word-meaning">${wordData.meaning}</span>
                `;
                wordsList.appendChild(wordEl);
            });

            // Display recognized forms
            if (recognizedForms.size > 0) {
                const formsEl = document.getElementById('recognizedForms');
                formsEl.innerHTML = '';
                
                recognizedForms.forEach((data, baseForm) => {
                    const formDiv = document.createElement('div');
                    formDiv.style.marginBottom = '0.5rem';
                    formDiv.innerHTML = `
                        <strong>${baseForm}</strong> (${data.base.romaji}): 
                        ${Array.from(data.forms).map(f => `<span class="form-item matched">${f}</span>`).join('')}
                    `;
                    formsEl.appendChild(formDiv);
                });
                
                document.getElementById('dictionaryInfo').style.display = 'block';
            } else {
                document.getElementById('dictionaryInfo').style.display = 'none';
            }

            document.getElementById('analysisResults').style.display = 'block';
            document.getElementById('knownWordsList').style.display = foundWords.size > 0 ? 'block' : 'none';
        }

        /* ---------- particles ---------- */
        function createParticles() {
            const chars = ['あ','か','さ','た','な','は','ま','や','ら','わ'];
            const container = document.getElementById('particles');
            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.textContent = chars[Math.floor(Math.random() * chars.length)];
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 10 + 's';
                p.style.animationDuration = (10 + Math.random() * 10) + 's';
                container.appendChild(p);
            }
        }

        /* ---------- hooks ---------- */
        romajiInput.addEventListener('keypress', e => { if (e.key === 'Enter') checkAnswer(); });
        document.getElementById('updateRangeBtn').addEventListener('click', updateRange);
        document.getElementById('resetBtn').addEventListener('click', resetProgress);
        document.getElementById('clearProgressBtn').addEventListener('click', clearProgress);
        document.getElementById('analyzeBtn').addEventListener('click', analyzeText);

        /* ---------- boot ---------- */
        createParticles();
        loadRange();
        updateRange();
        loadProgress();
        loadWord();
    </script>
</body>
</html>
