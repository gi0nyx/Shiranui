<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiranui</title>
    <link rel="stylesheet" href="style.css">
    <script src="tiny-segmenter-0.2.0.js"></script>
    <style>
        /* Additional styles for particle highlighting */
        .particle-word {
            background: linear-gradient(135deg, #f59e0b20 0%, #f9731620 100%);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            border-bottom: 2px solid #f59e0b;
            cursor: help;
            transition: all 0.2s ease;
        }

        .particle-word:hover {
            background: linear-gradient(135deg, #f59e0b30 0%, #f9731630 100%);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="container">
        <div class="header">
            <h1>日本語 practice</h1>
            <p class="subtitle">kaishi 1.5k deck • type the romaji</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="practice">Practice</button>
            <button class="tab-btn" data-tab="reading">Reading</button>
        </div>

        <!-- Practice Tab -->
        <div class="tab-content active" id="practice-tab">
            <div class="range-selector">
                <label>practice words from</label>
                <input type="number" id="startRange" min="1" max="1500" value="1">
                <label>to</label>
                <input type="number" id="endRange" min="1" max="1500" value="10">
                <button id="updateRangeBtn">update range</button>
            </div>

            <div class="card" id="card">
                <div class="japanese-word" id="japaneseWord"></div>
                <div class="meaning" id="meaning"></div>
                <div class="input-wrapper">
                    <input type="text" id="romajiInput" placeholder="type romaji..." autocomplete="off">
                </div>
            </div>

            <div class="progress">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText"></div>
            </div>

            <div class="controls">
                <button id="resetBtn">restart</button>
                <button id="clearProgressBtn">clear saved progress</button>
            </div>
        </div>

        <!-- Reading Tab -->
        <div class="tab-content" id="reading-tab">
            <div class="reading-controls">
                <div class="range-display">
                    <span>Using words from <strong id="readingRangeStart">1</strong> to <strong id="readingRangeEnd">10</strong></span>
                </div>
            </div>

            <div class="reading-section">
                <div class="input-section">
                    <label for="japaneseText">Enter Japanese text to analyze:</label>
                    <textarea 
                        id="japaneseText" 
                        placeholder="日本語のテキストを入力してください..."
                        rows="6"
                    ></textarea>
                    <button id="analyzeBtn">Analyze Text</button>
                </div>

                <div class="analysis-results" id="analysisResults" style="display: none;">
                    <div class="stats-card">
                        <div class="stat-item">
                            <span class="stat-label">Words Known</span>
                            <span class="stat-value" id="knownWordsCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Words</span>
                            <span class="stat-value" id="totalWordsCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Coverage</span>
                            <span class="stat-value" id="coveragePercent">0%</span>
                        </div>
                    </div>

                    <div class="highlighted-text-container">
                        <h3>Analyzed Text</h3>
                        <div id="highlightedText" class="highlighted-text"></div>
                    </div>

                    <div class="known-words-list" id="knownWordsList" style="display: none;">
                        <h3>Known Words Found</h3>
                        <div id="wordsListContent" class="words-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="stats">
        <div>streak: <span id="streak">0</span></div>
        <div>accuracy: <span id="accuracy">0%</span></div>
    </div>

    <script type="module">
        import kaishiWords from './kaishiWords.js';

        /* ---------- Storage Keys ---------- */
        const STORAGE_KEYS = {
            RANGE: 'shiranui_range',
            PROGRESS: 'shiranui_progress',
            STATS: 'shiranui_stats'
        };

        /* ---------- audio helper ---------- */
        const audio = new Audio();
        function playAudio(filename) {
            audio.src = `audio/${filename}.ogg`;
            audio.play().catch(e => console.log('audio play failed:', e));
        }

        /* ---------- state ---------- */
        let currentWords = [];
        let currentIndex = 0;
        let streak = 0, correct = 0, total = 0;

        /* ---------- DOM ---------- */
        const japaneseWordEl = document.getElementById('japaneseWord');
        const meaningEl      = document.getElementById('meaning');
        const romajiInput    = document.getElementById('romajiInput');
        const progressFill   = document.getElementById('progressFill');
        const progressText   = document.getElementById('progressText');
        const streakEl       = document.getElementById('streak');
        const accuracyEl     = document.getElementById('accuracy');
        const startRangeEl   = document.getElementById('startRange');
        const endRangeEl     = document.getElementById('endRange');

        /* ---------- Local Storage Functions ---------- */
        function saveProgress() {
            const progressData = {
                currentIndex,
                streak,
                correct,
                total,
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(progressData));
        }

        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEYS.PROGRESS);
            if (saved) {
                const data = JSON.parse(saved);
                currentIndex = data.currentIndex || 0;
                streak = data.streak || 0;
                correct = data.correct || 0;
                total = data.total || 0;
                updateStats();
            }
        }

        function saveRange() {
            const rangeData = {
                start: startRangeEl.value,
                end: endRangeEl.value
            };
            localStorage.setItem(STORAGE_KEYS.RANGE, JSON.stringify(rangeData));
        }

        function loadRange() {
            const saved = localStorage.getItem(STORAGE_KEYS.RANGE);
            if (saved) {
                const data = JSON.parse(saved);
                startRangeEl.value = data.start;
                endRangeEl.value = data.end;
            }
        }

        function clearProgress() {
            localStorage.removeItem(STORAGE_KEYS.PROGRESS);
            localStorage.removeItem(STORAGE_KEYS.STATS);
            resetProgress();
        }

        /* ---------- core ---------- */
        function updateRange() {
            const start = +startRangeEl.value - 1;
            const end   = +endRangeEl.value;
            currentWords = kaishiWords.slice(start, end);
            saveRange();
            resetProgress();
            updateReadingRange();
        }

        function resetProgress() {
            currentIndex = streak = correct = total = 0;
            updateStats();
            loadWord();
            saveProgress();
        }

        function loadWord() {
            if (currentIndex >= currentWords.length) {
                currentIndex = 0;
                japaneseWordEl.innerHTML =
                    '<div class="complete-message">ご苦労様でした nice job!</div>';
                romajiInput.style.display = 'none';
                setTimeout(() => { romajiInput.style.display = 'block'; loadWord(); }, 2000);
                saveProgress();
                return;
            }
            const w = currentWords[currentIndex];
            japaneseWordEl.textContent = w.japanese;
            meaningEl.textContent = `${w.romaji} • ${w.meaning}`;
            romajiInput.value = '';
            romajiInput.classList.remove('correct','incorrect');
            romajiInput.focus();
            updateProgress();
        }

        function updateProgress() {
            const pct = (currentIndex / currentWords.length) * 100;
            progressFill.style.width = pct + '%';
            progressText.textContent = `${currentIndex} / ${currentWords.length}`;
        }

        function updateStats() {
            streakEl.textContent = streak;
            accuracyEl.textContent = total ? `${Math.round(correct/total*100)}%` : '0%';
        }

        function checkAnswer() {
            const user = romajiInput.value.trim().toLowerCase();
            const ans  = currentWords[currentIndex].romaji.toLowerCase();
            total++;

            if (user === ans) {
                romajiInput.classList.add('correct');
                correct++; streak++;
                playAudio(currentWords[currentIndex].romaji);
                console.log('playing audio:', currentWords[currentIndex].romaji);
                setTimeout(() => { 
                    currentIndex++; 
                    loadWord(); 
                    saveProgress();
                }, 500);
            } else {
                romajiInput.classList.add('incorrect');
                streak = 0;
                playAudio('zenzen');
                setTimeout(() => romajiInput.classList.remove('incorrect'), 500);
            }
            updateStats();
            saveProgress();
        }

        /* ---------- Tab Navigation ---------- */
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;
                
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`${targetTab}-tab`).classList.add('active');
                
                if (targetTab === 'reading') {
                    updateReadingRange();
                }
            });
        });

        /* ---------- Reading Analysis with TinySegmenter ---------- */
        function updateReadingRange() {
            document.getElementById('readingRangeStart').textContent = startRangeEl.value;
            document.getElementById('readingRangeEnd').textContent = endRangeEl.value;
        }

        // Common Japanese particles
        const japaneseParticles = ['は', 'が', 'を', 'に', 'へ', 'で', 'と', 'から', 'まで', 'より', 'の', 'も', 'や', 'か', 'ね', 'よ', 'わ', 'ぞ', 'ぜ', 'な', 'さ', 'し', 'て', 'たり', 'だり', 'ごろ'];

        function analyzeText() {
            const inputText = document.getElementById('japaneseText').value;
            if (!inputText.trim()) return;

            // Initialize TinySegmenter
            const segmenter = new TinySegmenter();
            
            // Segment the text - this properly segments into words
            const segments = segmenter.segment(inputText);
            
            console.log('Segmented text:', segments); // Debug output
            
            // Create a map of known words from current range
            const knownWordsMap = new Map();
            currentWords.forEach(word => {
                knownWordsMap.set(word.japanese, word);
            });

            let highlightedHTML = '';
            let knownCount = 0;
            let totalWords = 0;
            const foundWords = new Map();

            // Process each segment
            segments.forEach(segment => {
                // Skip empty segments
                if (!segment || segment.trim() === '') {
                    return;
                }
                
                // Handle punctuation - don't count as words
                if (/^[、。！？「」『』（）\s]+$/.test(segment)) {
                    highlightedHTML += segment;
                    return;
                }

                // Check if it's a particle
                if (japaneseParticles.includes(segment)) {
                    highlightedHTML += `<span class="particle-word" title="Particle: ${segment}">${segment}</span>`;
                    totalWords++;
                    return;
                }

                // Check if this exact segment is in our known words
                if (knownWordsMap.has(segment)) {
                    const wordData = knownWordsMap.get(segment);
                    highlightedHTML += `<span class="known-word" title="${wordData.romaji} - ${wordData.meaning}">${segment}</span>`;
                    if (!foundWords.has(segment)) {
                        foundWords.set(segment, wordData);
                    }
                    knownCount++;
                    totalWords++;
                } else {
                    // Not a known word - mark as unknown
                    highlightedHTML += `<span class="unknown-word">${segment}</span>`;
                    totalWords++;
                }
            });

            // Update display
            document.getElementById('highlightedText').innerHTML = highlightedHTML;
            document.getElementById('knownWordsCount').textContent = knownCount;
            document.getElementById('totalWordsCount').textContent = totalWords;
            document.getElementById('coveragePercent').textContent = totalWords > 0 
                ? `${Math.round((knownCount / totalWords) * 100)}%` 
                : '0%';

            // Display found words list
            const wordsList = document.getElementById('wordsListContent');
            wordsList.innerHTML = '';
            foundWords.forEach((wordData, word) => {
                const wordEl = document.createElement('div');
                wordEl.className = 'word-item';
                wordEl.innerHTML = `
                    <span class="word-japanese">${word}</span>
                    <span class="word-romaji">${wordData.romaji}</span>
                    <span class="word-meaning">${wordData.meaning}</span>
                `;
                wordsList.appendChild(wordEl);
            });

            document.getElementById('analysisResults').style.display = 'block';
            if (foundWords.size > 0) {
                document.getElementById('knownWordsList').style.display = 'block';
            } else {
                document.getElementById('knownWordsList').style.display = 'none';
            }
        }

        /* ---------- particles ---------- */
        function createParticles() {
            const chars = ['あ','か','さ','た','な','は','ま','や','ら','わ'];
            const container = document.getElementById('particles');
            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.textContent = chars[Math.floor(Math.random() * chars.length)];
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 10 + 's';
                p.style.animationDuration = (10 + Math.random() * 10) + 's';
                container.appendChild(p);
            }
        }

        /* ---------- hooks ---------- */
        romajiInput.addEventListener('keypress', e => { if (e.key === 'Enter') checkAnswer(); });
        document.getElementById('updateRangeBtn').addEventListener('click', updateRange);
        document.getElementById('resetBtn').addEventListener('click', resetProgress);
        document.getElementById('clearProgressBtn').addEventListener('click', clearProgress);
        document.getElementById('analyzeBtn').addEventListener('click', analyzeText);

        /* ---------- boot ---------- */
        createParticles();
        loadRange();
        updateRange();
        loadProgress();
        loadWord();
    </script>
</body>
</html>